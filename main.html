<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Data from ThingSpeak</title>
    <link rel="stylesheet" href="styles.css"> <!-- Link to external CSS file -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.0/xlsx.full.min.js"></script>
    <!-- Add Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>Real-Time Data Monitoring</h1>

        <div class="flex-container">
            <!-- Line graph canvas -->
            <div class="chart-container">
                <canvas id="lineGraph" width="400" height="200"></canvas>
            </div>

            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Serial No.</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Gas Availability</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data rows will be dynamically added here -->
                    </tbody>
                </table>
                <button class="btn-download" onclick="exportToExcel()">Download Excel</button>
            </div>
        </div>
    </div>

    <script>
        // Function to fetch data from ThingSpeak and update table
        function fetchData() {
            $.getJSON('https://api.thingspeak.com/channels/2537626/feeds.json?api_key=CP0F620SXCUJ16OU&results=100', function(data) {
                // Clear existing rows
                $('#dataTable tbody').empty();
                var labels = [];
                var gasData = [];

                // Add rows for each fetched data point (in reversed order)
                $.each(data.feeds.reverse(), function(index, feed) {
                    var newRow = '<tr>';
                    var serialNo = data.feeds.length - index; // Reverse the serial number
                    var dateTime = new Date(feed.created_at);
                    newRow += '<td>' + serialNo + '</td>'; // Serial No.
                    newRow += '<td>' + dateTime.toLocaleDateString() + '</td>'; // Date
                    newRow += '<td>' + dateTime.toLocaleTimeString() + '</td>'; // Time
                    newRow += '<td>' + (feed.field1 == 1 ? 'Gas Present' : 'No Gas') + '</td>'; // Gas availability status
                    newRow += '</tr>';

                    // Append the new row to the table
                    $('#dataTable tbody').append(newRow);

                    // Populate data for line graph
                    labels.push(dateTime.toLocaleTimeString());
                    gasData.push(feed.field1 == 1 ? 1 : 0);
                });

                // Update the line graph
                createLineGraph(labels, gasData);
            });
        }

        // Fetch data initially
        fetchData();

        // Fetch data every 5 seconds (adjust the interval as needed)
        setInterval(fetchData, 5000);

        // Function to export table data to Excel
        function exportToExcel() {
            var table = document.getElementById("dataTable");
            
            // Get the table rows
            var rows = table.rows;

            // Create a new array to store the modified rows
            var newRows = [];

            // Iterate over the rows and exclude the first column (column A)
            for (var i = 0; i < rows.length; i++) {
                var newRow = [];

                // Copy columns from the original row, excluding the first one
                for (var j = 1; j < rows[i].cells.length; j++) {
                    newRow.push(rows[i].cells[j].innerText);
                }

                // Push the modified row to the newRows array
                newRows.push(newRow);
            }

            // Reverse the order of rows
            newRows.reverse();

            // Add the serial number to each row
            for (var i = 0; i < newRows.length; i++) {
                newRows[i].unshift(i + 1);
            }

            // Add column names
            var columnNames = ['Serial No.', 'Date', 'Time', 'Gas Availability'];
            newRows.unshift(columnNames);

            // Remove the last row (column names)
            newRows.pop();

            // Create a new workbook
            var wb = XLSX.utils.book_new();
            // Convert the modified rows to a worksheet
            var ws = XLSX.utils.aoa_to_sheet(newRows);
            // Add the worksheet to the workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data");

            // Convert the workbook to a binary Excel file
            var wbout = XLSX.write(wb, { bookType: "xlsx", type: "binary" });

            // Convert binary string to ArrayBuffer
            function s2ab(s) {
                var buf = new ArrayBuffer(s.length);
                var view = new Uint8Array(buf);
                for (var i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xff;
                return buf;
            }

            // Create a Blob object from the ArrayBuffer
            var blob = new Blob([s2ab(wbout)], { type: "application/octet-stream" });

            // Create a download link
            var url = window.URL.createObjectURL(blob);
            var link = document.createElement("a");
            link.href = url;
            link.download = "data.xlsx";

            // Trigger the download
            link.click();
        }

        // Function to create and update the line graph
        function createLineGraph(labels, data) {
            var ctx = document.getElementById('lineGraph').getContext('2d');
            var lineGraph = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Gas Availability Status',
                        data: data,
                        fill: false,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        x: {
                            ticks: {
                                autoSkip: true,
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
